---
import BaseLayout from "@layouts/BaseLayout.astro";
import CategoryFilter from "@components/CategoryFilter.astro";
import PostCard from "@components/PostCard.astro";
import {
  getAllCategories,
  getPostReadingTime,
  getPublishedPosts,
} from "@utils/blog";
import { siteConfig } from "@data/site";

const posts = await getPublishedPosts();
const categories = getAllCategories(posts);
const blogUrl = new URL(
  "/blog/",
  Astro.site ?? new URL(siteConfig.url),
).toString();
const blogJsonLd = [
  {
    "@context": "https://schema.org",
    "@type": "Blog",
    name: `${siteConfig.name} Blog`,
    description: "Latest technical writing on backend engineering and AI systems.",
    url: blogUrl,
    inLanguage: siteConfig.language,
  },
  {
    "@context": "https://schema.org",
    "@type": "ItemList",
    itemListElement: posts.map((post, index) => ({
      "@type": "ListItem",
      position: index + 1,
      url: new URL(
        `/blog/${post.slug}/`,
        Astro.site ?? new URL(siteConfig.url),
      ).toString(),
      name: post.data.title,
    })),
  },
];
---

<BaseLayout
  title="Blog"
  description="Latest technical blog posts, organized by category, tags, and search."
  keywords={[
    "Blog",
    "Backend Engineering",
    "AI Systems",
    ...categories,
  ]}
  jsonLd={blogJsonLd}
>
  <section class="space-y-8" data-blog-page>
    <section class="reading-surface space-y-5 p-5 sm:p-6">
      <div class="grid gap-4 md:grid-cols-2">
        <input
          type="search"
          aria-label="Search posts"
          data-blog-search
          placeholder="Search posts"
          class="h-11 rounded-xl border border-slate-300 bg-white px-4 text-sm text-slate-700 outline-none transition focus:border-sky-400 focus:ring-2 focus:ring-sky-500/30 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
        />

        <CategoryFilter
          categories={categories}
          id="blog"
          mode="select"
          label="Category"
          hideLabel={true}
        />
      </div>

      <div class="flex flex-wrap items-center justify-between gap-3">
        <p data-blog-results class="text-sm text-slate-600 dark:text-slate-300">
          {posts.length} posts found
        </p>
        <button
          type="button"
          data-clear-filters
          class="text-sm font-medium text-sky-700 hover:text-sky-500 dark:text-sky-300 dark:hover:text-sky-200"
        >
          Clear filters
        </button>
      </div>
    </section>

    <div class="grid gap-6" data-blog-post-list>
      {
        posts.map((post) => (
          <PostCard
            slug={post.slug}
            title={post.data.title}
            description={post.data.description}
            publishedDate={post.data.publishedDate}
            readingTime={getPostReadingTime(post)}
            tags={post.data.tags}
            category={post.data.category}
            featuredImage={post.data.featuredImage}
          />
        ))
      }
    </div>

    <p
      data-blog-empty
      class="hidden rounded-xl border border-dashed border-slate-300 p-6 text-sm text-slate-500 dark:border-slate-700 dark:text-slate-300"
    >
      No posts match your filters.
    </p>

    <nav
      data-blog-pagination
      class="hidden flex-wrap items-center justify-center gap-2"
      aria-label="Pagination"
    >
    </nav>
  </section>

  <script is:inline>
    const initializeBlogFilters = () => {
      const PER_PAGE = 10;
      const roots = Array.from(document.querySelectorAll("[data-blog-page]"));
      const root = roots[roots.length - 1];

      if (!(root instanceof HTMLElement)) {
        return;
      }

      if (root.dataset.bound === "true") {
        return;
      }

      root.dataset.bound = "true";

      const postList = root.querySelector("[data-blog-post-list]");
      const searchInput = root.querySelector("[data-blog-search]");
      const categorySelect = root.querySelector('[data-category-select="blog"]');
      const cards =
        postList instanceof HTMLElement
          ? Array.from(postList.querySelectorAll("[data-post-card]"))
          : [];
      const resultsText = root.querySelector("[data-blog-results]");
      const emptyState = root.querySelector("[data-blog-empty]");
      const pagination = root.querySelector("[data-blog-pagination]");
      const clearButton = root.querySelector("[data-clear-filters]");

      if (
        !cards.length ||
        !(searchInput instanceof HTMLInputElement) ||
        !(categorySelect instanceof HTMLSelectElement) ||
        !(pagination instanceof HTMLElement) ||
        !(postList instanceof HTMLElement)
      ) {
        return;
      }

      const params = new URLSearchParams(window.location.search);
      let activeCategory = (params.get("category") ?? "").toLowerCase();
      let currentPage = Number(params.get("page") ?? "1");

      if (!Number.isFinite(currentPage) || currentPage < 1) {
        currentPage = 1;
      }

      if (activeCategory) {
        const matchingOption = Array.from(categorySelect.options).find(
          (option) => option.value.toLowerCase() === activeCategory,
        );

        if (matchingOption) {
          categorySelect.value = matchingOption.value;
        }
      }

      const filterCards = () => {
        const query = searchInput.value.trim().toLowerCase();

        return cards.filter((card) => {
          const title = card.dataset.title ?? "";
          const description = card.dataset.description ?? "";
          const category = card.dataset.category ?? "";
          const tags = (card.dataset.tags ?? "")
            .split(",")
            .map((item) => item.trim());

          const matchesCategory =
            !activeCategory || category === activeCategory;
          const matchesQuery =
            !query ||
            title.includes(query) ||
            description.includes(query) ||
            tags.some((tag) => tag.includes(query)) ||
            category.includes(query);

          return matchesCategory && matchesQuery;
        });
      };

      const updateUrl = (totalPages) => {
        const nextParams = new URLSearchParams();

        if (activeCategory) {
          nextParams.set("category", activeCategory);
        }

        if (searchInput.value.trim()) {
          nextParams.set("q", searchInput.value.trim());
        }

        if (currentPage > 1 && currentPage <= totalPages) {
          nextParams.set("page", String(currentPage));
        }

        const query = nextParams.toString();
        const nextUrl = query
          ? `${window.location.pathname}?${query}`
          : window.location.pathname;
        history.replaceState({}, "", nextUrl);
      };

      const renderPagination = (totalPages) => {
        pagination.innerHTML = "";

        if (totalPages <= 1) {
          pagination.classList.add("hidden");
          return;
        }

        pagination.classList.remove("hidden");

        const createNavButton = (label, nextPage, disabled = false) => {
          const button = document.createElement("button");
          button.type = "button";
          button.textContent = label;
          button.disabled = disabled;
          button.className =
            "rounded-lg border border-slate-300 px-3 py-1.5 text-sm font-medium text-slate-700 transition hover:border-sky-400 hover:text-sky-700 dark:border-slate-700 dark:text-slate-200 dark:hover:border-sky-400 dark:hover:text-sky-300" +
            (disabled ? " cursor-not-allowed opacity-50" : "");

          if (!disabled) {
            button.addEventListener("click", () => {
              currentPage = nextPage;
              render();
              window.scrollTo({ top: 0, behavior: "smooth" });
            });
          }

          return button;
        };

        const prevButton = createNavButton(
          "Previous",
          Math.max(1, currentPage - 1),
          currentPage === 1,
        );

        const pageStatus = document.createElement("span");
        pageStatus.className =
          "px-3 py-1.5 text-sm font-medium text-slate-600 dark:text-slate-300";
        pageStatus.textContent = `Page ${currentPage} of ${totalPages}`;

        const nextButton = createNavButton(
          "Next",
          Math.min(totalPages, currentPage + 1),
          currentPage === totalPages,
        );

        pagination.append(prevButton, pageStatus, nextButton);
      };

      const render = (resetPage = false) => {
        if (resetPage) {
          currentPage = 1;
        }

        const filtered = filterCards();
        const totalPages = Math.max(1, Math.ceil(filtered.length / PER_PAGE));

        if (currentPage > totalPages) {
          currentPage = totalPages;
        }

        cards.forEach((card) => card.classList.add("hidden"));

        const start = (currentPage - 1) * PER_PAGE;
        const end = start + PER_PAGE;
        filtered
          .slice(start, end)
          .forEach((card) => card.classList.remove("hidden"));

        if (resultsText) {
          resultsText.textContent = `${filtered.length} post${filtered.length === 1 ? "" : "s"} found`;
        }

        if (emptyState) {
          emptyState.classList.toggle("hidden", filtered.length !== 0);
        }

        renderPagination(totalPages);
        updateUrl(totalPages);
      };

      const initialQuery = params.get("q");
      if (initialQuery) {
        searchInput.value = initialQuery;
      }

      searchInput.addEventListener("input", () => render(true));

      categorySelect.addEventListener("change", () => {
        activeCategory = categorySelect.value.toLowerCase();
        render(true);
      });

      if (clearButton) {
        clearButton.addEventListener("click", () => {
          activeCategory = "";
          categorySelect.value = "";
          searchInput.value = "";
          render(true);
        });
      }

      render();
    };

    initializeBlogFilters();
    document.addEventListener("astro:page-load", initializeBlogFilters);
  </script>
</BaseLayout>
