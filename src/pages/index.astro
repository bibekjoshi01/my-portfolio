---
import BaseLayout from "@layouts/BaseLayout.astro";
import PostCard from "@components/PostCard.astro";
import NewsletterForm from "@components/NewsletterForm.astro";
import { getPostReadingTime, getPublishedPosts } from "@utils/blog";
import { siteConfig } from "@data/site";
import { getAuthorProfile } from "@data/authors";

const posts = await getPublishedPosts();
const featuredPosts = posts.filter((post) => post.data.featured);
const author = getAuthorProfile("Bibek Joshi");

const homeJsonLd = [
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    name: siteConfig.name,
    description: siteConfig.description,
    url: Astro.site?.toString(),
  },
  {
    "@context": "https://schema.org",
    "@type": "Person",
    name: author.name,
    jobTitle: author.role,
    description: author.bio,
    image: author.avatar,
    sameAs: author.social
      .map((social) => social.url)
      .filter((url) => url.startsWith("http")),
    ...(author.portfolioUrl ? { url: author.portfolioUrl } : {}),
  },
];

const SOCIAL_ICONS: Record<string, string> = {
  GitHub:
    "M12 .5C5.65.5.5 5.65.5 12c0 5.08 3.29 9.39 7.86 10.91.57.1.78-.25.78-.55 0-.27-.01-1.16-.02-2.1-3.2.7-3.88-1.35-3.88-1.35-.52-1.33-1.27-1.68-1.27-1.68-1.04-.71.08-.7.08-.7 1.15.08 1.76 1.18 1.76 1.18 1.02 1.76 2.68 1.25 3.33.96.1-.74.4-1.25.72-1.54-2.56-.29-5.25-1.28-5.25-5.69 0-1.26.45-2.29 1.18-3.1-.12-.29-.51-1.45.11-3.02 0 0 .97-.31 3.17 1.18a10.96 10.96 0 0 1 5.78 0c2.2-1.49 3.17-1.18 3.17-1.18.62 1.57.23 2.73.11 3.02.73.81 1.18 1.84 1.18 3.1 0 4.42-2.7 5.39-5.27 5.67.41.36.78 1.07.78 2.16 0 1.56-.01 2.81-.01 3.19 0 .3.2.66.79.55A11.5 11.5 0 0 0 23.5 12C23.5 5.65 18.35.5 12 .5Z",
  LinkedIn:
    "M4.98 3.5A2.48 2.48 0 1 0 5 8.45a2.48 2.48 0 0 0-.02-4.95ZM3 9h4v12H3V9Zm7 0h3.83v1.64h.05c.53-1 1.84-2.05 3.8-2.05 4.06 0 4.82 2.67 4.82 6.13V21h-4v-5.67c0-1.35-.02-3.08-1.88-3.08-1.88 0-2.17 1.47-2.17 2.98V21h-4V9Z",
  YouTube:
    "M23.5 7.2a3.04 3.04 0 0 0-2.14-2.15C19.5 4.5 12 4.5 12 4.5s-7.5 0-9.36.55A3.04 3.04 0 0 0 .5 7.2 31.5 31.5 0 0 0 0 12a31.5 31.5 0 0 0 .5 4.8 3.04 3.04 0 0 0 2.14 2.15C4.5 19.5 12 19.5 12 19.5s7.5 0 9.36-.55a3.04 3.04 0 0 0 2.14-2.15A31.5 31.5 0 0 0 24 12a31.5 31.5 0 0 0-.5-4.8ZM9.75 15.5v-7l6 3.5-6 3.5Z",
  Email:
    "M2 5.5A2.5 2.5 0 0 1 4.5 3h15A2.5 2.5 0 0 1 22 5.5v13a2.5 2.5 0 0 1-2.5 2.5h-15A2.5 2.5 0 0 1 2 18.5v-13Zm2.45.5 7.55 5.3 7.55-5.3H4.45Zm15.55 2.44-6.85 4.8a2 2 0 0 1-2.3 0L4 8.44v10.06c0 .28.22.5.5.5h15a.5.5 0 0 0 .5-.5V8.44Z",
};

const getIconPath = (label: string) =>
  SOCIAL_ICONS[label] ?? SOCIAL_ICONS.Email;
---

<BaseLayout
  title="Home"
  description={siteConfig.description}
  jsonLd={homeJsonLd}
>
  <section class="space-y-12">
    <header
      class="reading-surface grid gap-6 p-6 sm:p-8 lg:grid-cols-[220px,1fr] lg:items-center"
    >
      <img
        src={author.avatar}
        alt={author.name}
        width="340"
        height="340"
        class="h-40 w-40 rounded-full border border-slate-200 object-cover dark:border-slate-700 sm:h-52 sm:w-52"
        loading="eager"
      />

      <div class="space-y-4">
        <p
          class="text-sm font-semibold uppercase tracking-[0.14em] text-sky-700 dark:text-sky-300"
        >
          About Me
        </p>
        <h1
          class="text-4xl font-bold tracking-tight text-slate-900 dark:text-slate-50 sm:text-5xl"
        >
          {author.name}
        </h1>
        <p class="text-base font-semibold text-slate-700 dark:text-slate-200">
          {author.role}
        </p>
        <p
          class="max-w-3xl text-lg leading-8 text-slate-600 dark:text-slate-300"
        >
          {author.bio}
        </p>
        <p
          class="max-w-3xl text-base leading-7 text-slate-600 dark:text-slate-300"
        >
          {siteConfig.tagline}
        </p>

        <div class="flex flex-wrap items-center gap-3">
          {
            author.social.map((social) => (
              <a
                href={social.url}
                target={social.url.startsWith("http") ? "_blank" : undefined}
                rel={
                  social.url.startsWith("http")
                    ? "noopener noreferrer"
                    : undefined
                }
                class="inline-flex items-center gap-2 rounded-full border border-slate-300 px-4 py-2 text-sm font-medium text-slate-700 transition hover:border-sky-400 hover:text-sky-700 dark:border-slate-700 dark:text-slate-200 dark:hover:border-sky-400 dark:hover:text-sky-300"
              >
                <svg
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                  class="h-4 w-4 fill-current"
                >
                  <path d={getIconPath(social.label)} />
                </svg>
                {social.label}
              </a>
            ))
          }
          {
            author.portfolioUrl && (
              <a
                href={author.portfolioUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="rounded-full bg-slate-900 px-4 py-2 text-sm font-semibold text-white transition hover:bg-slate-700 dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-white"
              >
                Portfolio
              </a>
            )
          }
        </div>
      </div>
    </header>

    {
      featuredPosts.length > 0 && (
        <section class="space-y-5">
          <div class="flex items-center justify-between">
            <h2 class="text-2xl font-semibold text-slate-900 dark:text-slate-100">
              Featured Posts
            </h2>
            <a
              href="/blog"
              class="text-sm font-medium text-sky-700 hover:text-sky-500 dark:text-sky-300 dark:hover:text-sky-200"
            >
              View all posts
            </a>
          </div>

          <div class="grid gap-5 md:grid-cols-2 xl:grid-cols-3">
            {featuredPosts.map((post) => (
              <PostCard
                slug={post.slug}
                title={post.data.title}
                description={post.data.description}
                publishedDate={post.data.publishedDate}
                readingTime={getPostReadingTime(post)}
                tags={post.data.tags}
                category={post.data.category}
                featuredImage={post.data.featuredImage}
                featured={post.data.featured}
              />
            ))}
          </div>
        </section>
      )
    }

    <div class="mx-auto w-full max-w-2xl xl:w-1/2 xl:max-w-none">
      <NewsletterForm
        formId="newsletter-home"
        title="Get New Articles in Your Inbox"
        description="A concise email whenever a new technical post is published."
      />
    </div>
  </section>
</BaseLayout>
