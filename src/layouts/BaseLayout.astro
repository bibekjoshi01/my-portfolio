---
import { ViewTransitions } from "astro:transitions";
import ThemeToggle from "@components/ThemeToggle.astro";
import BackToTop from "@components/BackToTop.astro";
import { defaultOgImage, siteConfig } from "@data/site";
import "../styles/global.css";

interface Props {
  title: string;
  description?: string;
  canonical?: string;
  ogImage?: string;
  type?: "website" | "article";
  jsonLd?: Record<string, unknown> | Array<Record<string, unknown>>;
}

const {
  title,
  description = siteConfig.description,
  canonical,
  ogImage = defaultOgImage,
  type = "website",
  jsonLd,
} = Astro.props;

const siteUrl = Astro.site ?? new URL(siteConfig.url);
const canonicalUrl =
  canonical ?? new URL(Astro.url.pathname, siteUrl).toString();
const absoluteOgImage = ogImage.startsWith("http")
  ? ogImage
  : new URL(ogImage, siteUrl).toString();
const metaTitle = title.includes(siteConfig.name)
  ? title
  : `${title} | ${siteConfig.name}`;
const jsonLdPayload = jsonLd ? JSON.stringify(jsonLd) : "";
---

<!doctype html>
<html
  lang="en"
  class="selection:bg-sky-200 selection:text-sky-900 dark:selection:bg-sky-500 dark:selection:text-slate-950"
>
  <head>
    <ViewTransitions />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl} />
    <meta property="og:type" content={type} />
    <meta property="og:title" content={metaTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={absoluteOgImage} />
    <meta property="og:site_name" content={siteConfig.name} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={metaTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={absoluteOgImage} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{metaTitle}</title>

    <script is:inline>
      (() => {
        const key = "theme-preference";
        const stored = localStorage.getItem(key);
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)",
        ).matches;
        const resolved = stored ?? (prefersDark ? "dark" : "light");
        document.documentElement.classList.toggle("dark", resolved === "dark");
      })();
    </script>

    {
      jsonLdPayload && (
        <script type="application/ld+json" set:html={jsonLdPayload} />
      )
    }
  </head>

  <body>
    <header
      class="sticky top-0 z-50 border-b border-slate-200/80 bg-surface-light/90 backdrop-blur dark:border-slate-800/80 dark:bg-surface-dark/90"
    >
      <div class="container-shell flex h-16 items-center justify-between gap-4">
        <a
          href="/"
          class="text-sm font-bold uppercase tracking-[0.12em] text-slate-900 dark:text-slate-100"
        >
          {siteConfig.name}
        </a>

        <nav class="flex items-center">
          <ThemeToggle />
        </nav>
      </div>
    </header>

    <main class="container-shell py-10 sm:py-14">
      <slot />
    </main>

    <footer class="border-t border-slate-200 py-10 dark:border-slate-800">
      <div
        class="container-shell text-center text-sm text-slate-500 dark:text-slate-400"
      >
        <p>
          Â© {new Date().getFullYear()}
          {siteConfig.name}. All rights reserved.
        </p>
      </div>
    </footer>

    <BackToTop />
  </body>
</html>
